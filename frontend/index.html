<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>FaceTime</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div id="app">
    <!-- Mobile header -->
    <div id="mobile-header">
      <button class="btn-icon" id="menu-btn" aria-label="Open menu"></button>
      <h1>FaceTime</h1>
      <button class="btn-icon" id="mobile-settings-btn" aria-label="Settings"></button>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <h1>FaceTime</h1>
      </div>
      <div class="sidebar-search">
        <div class="search-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="search-input" placeholder="Search contacts..." autocomplete="off">
        </div>
      </div>
      <div class="sidebar-actions">
        <button class="btn-add" id="add-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
          Add Contact
        </button>
      </div>
      <div id="contacts-list"></div>
      <div class="sidebar-footer">
        <button class="btn-footer" id="settings-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </button>
        <button class="btn-footer" id="sim-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.13.81.36 1.6.69 2.36a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.76.33 1.55.56 2.36.69A2 2 0 0 1 22 16.92z"/></svg>
          Simulate Call
        </button>
      </div>
    </aside>

    <!-- Main area -->
    <main id="main-content">
      <!-- Idle -->
      <div id="idle-screen">
        <div class="idle-inner">
          <div class="idle-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m16 2 5 5-5 5"/><path d="M21 7H9"/><path d="m8 22-5-5 5-5"/><path d="M3 17h12"/></svg>
          </div>
          <h2>FaceTime</h2>
          <p>Select a contact from the sidebar to start a video call</p>
        </div>
      </div>

      <!-- Calling -->
      <div id="calling-screen" class="hidden">
        <div class="calling-inner">
          <div class="calling-avatar-wrap">
            <div class="avatar-circle" id="calling-avatar"></div>
            <div class="ring"></div>
            <div class="ring"></div>
            <div class="ring"></div>
          </div>
          <h2 id="calling-name"></h2>
          <p class="calling-label">FaceTime Video...</p>
          <button class="btn-end" id="cancel-call-btn" aria-label="Cancel call"></button>
        </div>
      </div>

      <!-- In-call -->
      <div id="call-screen" class="hidden">
        <div id="remote-area"></div>
        <div id="pip-wrap">
          <video id="local-video" autoplay playsinline muted></video>
          <div class="pip-no-cam hidden" id="pip-no-cam">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.5 3H4a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-3"/><line x1="2" y1="2" x2="22" y2="22"/></svg>
          </div>
        </div>
        <div id="call-info">
          <span class="info-name" id="info-name"></span>
          <span class="info-timer" id="info-timer">00:00</span>
        </div>
        <div id="call-controls">
          <button class="ctrl-btn" id="ctrl-mute" aria-label="Mute">
            <span class="ctrl-label">Mute</span>
          </button>
          <button class="ctrl-btn" id="ctrl-cam" aria-label="Camera">
            <span class="ctrl-label">Camera</span>
          </button>
          <button class="ctrl-btn" id="ctrl-flip" aria-label="Flip camera">
            <span class="ctrl-label">Flip</span>
          </button>
          <button class="ctrl-btn end-call" id="ctrl-end" aria-label="End call">
          </button>
          <button class="ctrl-btn" id="ctrl-settings" aria-label="Settings">
            <span class="ctrl-label">More</span>
          </button>
        </div>
      </div>
    </main>

    <!-- Incoming call banner -->
    <div id="incoming-call">
      <div class="incoming-inner">
        <div class="incoming-avatar" id="inc-avatar"></div>
        <div class="incoming-info">
          <h3 id="inc-name"></h3>
          <p>FaceTime Video</p>
        </div>
        <div class="incoming-btns">
          <button class="btn-round decline" id="inc-decline" aria-label="Decline">
          </button>
          <button class="btn-round accept" id="inc-accept" aria-label="Accept">
          </button>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div id="settings-panel">
      <div class="settings-box">
        <div class="settings-head">
          <h2>Settings</h2>
          <button class="btn-close" id="close-settings" aria-label="Close settings"></button>
        </div>
        <div class="settings-body">
          <div class="setting-group">
            <label for="sel-camera">Camera</label>
            <select id="sel-camera"><option>Default Camera</option></select>
          </div>
          <div class="setting-group">
            <label for="sel-mic">Microphone</label>
            <select id="sel-mic"><option>Default Microphone</option></select>
          </div>
          <div class="setting-group">
            <label for="sel-speaker">Audio Output</label>
            <select id="sel-speaker"><option>Default Speaker</option></select>
          </div>
          <div class="setting-group setting-toggle">
            <span>Mirror Camera</span>
            <button class="toggle-track on" id="toggle-mirror" aria-label="Toggle mirror camera"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add contact modal -->
    <div id="add-modal">
      <div class="modal-box">
        <h2>Add Contact</h2>
        <input type="text" id="inp-name" placeholder="Name" autocomplete="off">
        <input type="text" id="inp-detail" placeholder="Phone number or email" autocomplete="off">
        <div class="modal-btns">
          <button class="btn-m-cancel" id="modal-cancel">Cancel</button>
          <button class="btn-m-confirm" id="modal-confirm">Add</button>
        </div>
      </div>
    </div>
  </div>

  <script>


    // ---- PiP Drag ----

    // Reset PiP position when entering a call
    function resetPipPosition() {
      pipWrap.style.position = '';
      pipWrap.style.left = '';
      pipWrap.style.top = '';
      pipWrap.style.right = '';
      pipWrap.style.transition = '';
    }

    // Patch connectCall to reset pip
    const _origConnect = connectCall;
    connectCall = async function(contact) {
      resetPipPosition();
      await _origConnect(contact);
    };

    // ---- Event Listeners ----

    // Mobile menu
    $('#menu-btn').addEventListener('click', openSidebar);
    sidebarOvl.addEventListener('click', closeSidebar);

    // Search
    searchInput.addEventListener('input', () => renderContacts(searchInput.value));

    // Add contact
    $('#add-btn').addEventListener('click', openAddModal);
    $('#modal-cancel').addEventListener('click', closeAddModal);
    $('#modal-confirm').addEventListener('click', addContact);
    $('#inp-name').addEventListener('keydown', (e) => { if (e.key === 'Enter') $('#inp-detail').focus(); });
    $('#inp-detail').addEventListener('keydown', (e) => { if (e.key === 'Enter') addContact(); });
    addModal.addEventListener('click', (e) => { if (e.target === addModal) closeAddModal(); });

    // Settings
    $('#settings-btn').addEventListener('click', openSettings);
    $('#mobile-settings-btn').addEventListener('click', openSettings);
    $('#close-settings').addEventListener('click', closeSettings);
    $('#ctrl-settings').addEventListener('click', openSettings);
    settingsPanel.addEventListener('click', (e) => { if (e.target === settingsPanel) closeSettings(); });

    // Mirror toggle
    $('#toggle-mirror').addEventListener('click', function() {
      state.isMirrored = !state.isMirrored;
      this.classList.toggle('on', state.isMirrored);
      localVideo.classList.toggle('no-mirror', !state.isMirrored);
    });

    // Camera select change
    $('#sel-camera').addEventListener('change', function() {
      changeCamera(this.value);
    });

    // Audio output change
    $('#sel-speaker').addEventListener('change', function() {
      if (localVideo.setSinkId) {
        localVideo.setSinkId(this.value).catch(() => {});
      }
    });

    // Call controls
    $('#ctrl-mute').addEventListener('click', toggleMute);
    $('#ctrl-cam').addEventListener('click', toggleCamera);
    $('#ctrl-flip').addEventListener('click', flipCamera);
    $('#ctrl-end').addEventListener('click', endCall);
    $('#cancel-call-btn').addEventListener('click', cancelCall);

    // Incoming call
    $('#sim-btn').addEventListener('click', simulateIncoming);
    $('#inc-accept').addEventListener('click', acceptIncoming);
    $('#inc-decline').addEventListener('click', declineIncoming);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      if (e.key === 'Escape') {
        if (addModal.classList.contains('show')) closeAddModal();
        else if (settingsPanel.classList.contains('show')) closeSettings();
        else if (incomingEl.classList.contains('show')) declineIncoming();
        else if (state.screen === 'calling') cancelCall();
      }
      if (e.key === 'm' && state.screen === 'incall') toggleMute();
      if (e.key === 'v' && state.screen === 'incall') toggleCamera();
    });

    // ---- Init ----
    renderContacts();
    updateControlIcons();
  </script>
</body>
</html>
